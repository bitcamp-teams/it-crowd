<!DOCTYPE html>
<html lang='en' data-th-fragment="header" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>모두의스터디</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/auth/modal.css">
    <link rel="stylesheet" href="/css/home/styles.css">
    <link rel="stylesheet" href="/css/auth/styles.css">
    <!-- jQuery -->
    <script src="/plugins/jquery/jquery.min.js"></script>
    <!-- bootstrap 4 css   -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <!-- Bootstrap 4 -->
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- TUI 에디터 CSS CDN -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <!-- code syntax-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"/>
    <link rel="stylesheet"
          href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet" href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="/plugins/jqvmap/jqvmap.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/css/adminlte.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="/plugins/daterangepicker/daterangepicker.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
    <!-- BS Stepper -->
    <link rel="stylesheet" href="/plugins/bs-stepper/css/bs-stepper.min.css">

</head>

<header id="header">
    <a href="/">
        <img src='/img/logo_text.png'>
    </a>
    <div>
        <a href="/study/list">스터디 찾기</a>
        <a href="/study/form">모집 글 쓰기</a>
        <a href="/wiki/modoowikilist">모두의 위키</a>
        <button data-th-if="${session.loginUser != null}" onclick="fetchNotifications()">알림</button>
        <div id="popupNotifications" class="popup-noti" style="display: none;">
            <div class="popup-noti-content">
                <span class="close">&times;</span>
                <h2>알림</h2>
                <div id="notifications"></div>
            </div>
        </div>
        <span data-th-if="${session.loginUser != null}" data-th-text="${session.loginUser.email}">로그인 이메일</span>
        <span data-th-if="${session.loginUser != null}">[[${session.platform}]]</span>
        <button data-th-if="${session.loginUser != null}" onclick="location.href='/auth/logout';">로그아웃</button>
        <!-- 로그인 버튼 클릭 시 모달 열기 -->
        <button data-th-if="${session.loginUser == null}" class="btn-open-modal btn btn-outline-info" data-toggle="modal"
                data-target="#loginModal">로그인
        </button>
    </div>
</header>
<body>

<style>
    /* 팝업창 스타일 */
    .popup-noti {
        position: absolute;
        z-index: 1;
        width: 300px;
        background-color: #fefefe;
        margin-top: 20px; /* 버튼과의 거리 */
        border: 1px solid #888;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    }

    .popup-noti-content {
        padding: 20px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }


</style>




<script th:inline="javascript">
    // 팝업 창 요소를 가져옴
    var popup = document.getElementById("popupNotifications");

    // 닫기 버튼 요소를 가져옴
    var span = document.getElementsByClassName("close")[0];



    function fetchNotifications() {
        console.log("fetchNotifications 함수가 호출되었습니다.");
        // 서버로부터 알림 목록을 가져오는 AJAX 요청
        fetch('/noti/list')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(notiListJson => {
            console.log(notiListJson);
            displayNotifications(JSON.stringify(notiListJson));
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    span.onclick = function() {
        popup.style.display = "none";
    }
    window.onclick = function(event) {
        popup.style.display = "none";
    }

    // 알림 데이터를 파싱하고 화면에 표시하는 함수
    function displayNotifications(notiListJson) {
        console.log(notiListJson);

        console.log("displayNotifications 함수가 호출되었습니다.");
        var notiList = JSON.parse(notiListJson);

        var notificationsContainer = document.getElementById('notifications');
        // 기존에 표시된 알림을 클리어
        notificationsContainer.innerHTML = '';
        popup.style.display = "block";
        if (notiList.length === 0) {
        // 알림 데이터가 없을 경우 표시할 메시지
        notificationsContainer.textContent = '알림이 없습니다.';
        } else {
            notiList.forEach(function(noti) {
                var notiElement = document.createElement('div');
                var linkElement = document.createElement('a');
                linkElement.href = noti.link; // 링크 설정
                linkElement.textContent = noti.message; // 메시지 텍스트 설정
                linkElement.addEventListener('click', function() {
                    sendReadRequest(noti);
                });
                // linkElement.target = "_blank"; // 새 탭에서 링크 열기를 원할 경우 활성화
                notiElement.appendChild(linkElement);
                notificationsContainer.appendChild(notiElement);
        });
    }
    }
    function sendReadRequest(noti) {
        // 요청 본문에 JSON 형식으로 알림 ID를 포함
        console.log("클릭 이벤트 발생");
        const requestBody = JSON.stringify({ id: noti.id });

        console.log(requestBody);
        fetch('/noti/update', {
            method: 'POST', // 요청 메서드를 POST로 설정
            headers: {
                'Content-Type': 'application/json', // JSON 형식의 데이터를 전송하므로 Content-Type을 application/json으로 설정
            },
            body: requestBody, // JSON 형식의 요청 본문
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); // 여기서는 서버가 JSON을 반환한다고 가정합니다. 실제 응답 형식에 맞춰 조정할 수 있습니다.
        })
        .then(data => {
            console.log(data); // 서버로부터의 응답 처리
            // 여기서 추가적인 작업을 수행할 수 있습니다. 예를 들어, 알림을 읽음 처리한 후 UI를 갱신할 수 있습니다.
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
    }

    /*]]>*/
</script>

<!-- 모달 -->
<div class="modal" id="loginModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="loginModalContent">
        </div>
    </div>
</div>

<!-- axios -->
<script src="/plugins/axios/axios.min.js"></script>
<!-- 별도의 JavaScript 파일 추가 -->
<script type="module" src="/js/auth/modal.js"></script>

<!-- Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- Viewer -->
<!--
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.js"></script>
-->
<!-- Editor's Plugin -->
<script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>