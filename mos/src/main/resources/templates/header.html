gi<!DOCTYPE html>
<html lang='en' data-th-fragment="header" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta>
  <title>모두의스터디</title>
  <!-- custom css   -->
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/auth/modal.css">
  <link rel="stylesheet" href="/css/auth/styles.css">
  <link rel="stylesheet" href="/css/home/styles.css">
  <link rel="stylesheet" href="/css/study/main.css">
  <!-- jQuery -->
  <script src="/plugins/jquery/jquery.min.js"></script>
  <!-- Select2 css -->
  <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
  <!-- Select2 js -->
  <script src="/plugins/select2/js/select2.full.min.js"></script>
  <!-- bootstrap 4 css   -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
        crossorigin="anonymous">
  <!-- Bootstrap 4 -->
  <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- TUI 에디터 CSS CDN -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
  <!-- code syntax-->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"/>
  <link rel="stylesheet"
        href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet"
        href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="/plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="/plugins/daterangepicker/daterangepicker.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
  <script src="/plugins/sweetalert2/sweetalert2.min.js"></script>
  <!-- BS Stepper -->
  <link rel="stylesheet" href="/plugins/bs-stepper/css/bs-stepper.min.css">
  <!-- jquery-validation -->
  <script src="/plugins/jquery-validation/jquery.validate.min.js"></script>
  <script src="/plugins/jquery-validation/additional-methods.min.js"></script>
  <script src="/plugins/serialize-object/serialize-object.min.js"></script>
  <style>
    .dropdown {
        display: inline-block;
        position: relative;
    }

    .dropdown-options {
        display: none;
        position: absolute;
        overflow: auto;
        z-index: 9999;
    }

    .dropdown:hover .dropdown-options {
        display: grid;
        width: 180px;
        grid-auto-rows: min-content;
        gap: 8px;
        padding: 10px;
        border: 1px solid #000000;
        border-bottom: 1px solid #000000;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    /* 팝업창 스타일 */
    .popup-noti {
        position: absolute;
        right: 99px;
        top: 20px;
        z-index: 1;
        width: 300px;
        background-color: #fefefe;
        margin-top: 20px; /* 버튼과의 거리 */
        border: 1px solid #888;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        max-height: 250px; /* 팝업의 최대 높이 설정 */
        overflow-y: auto; /* 세로 스크롤바 설정. 내용이 최대 높이를 초과할 경우 자동으로 스크롤바가 생성됨 */
    }

    .popup-noti-content {
        padding: 20px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>

<!--<header id="header">-->
<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #DBEAFE;">
  <a class="navbar-brand" href="/"><img src='/img/logo_text.png'></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse"
          data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
          aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse position-relative" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="/study/main">스터디 모집 목록</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/study/list">스터디 찾기</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/study/form">모집 글 쓰기</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/wiki/modoowikilist">모두의 위키</a>
      </li>
    </ul>
    <button class="btn btn-navbar bg-blue mr-sm-2" data-th-if="${session.loginUser != null}"
            onclick="showPopup()">알림
    </button>
    <div id="popupNotifications" class="popup-noti mr-sm-2" style="display: none;">
      <div class="popup-noti-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <h2>알림</h2>
        <div id="notifications"></div>
        <div id="pageButtons"></div> <!-- 페이징 버튼을 위한 공간 추가 -->
      </div>
    </div>

    <div class="dropdown mr-sm-2">
      <a href="javascript:void(0)" alt="icon image">
        <img src="/img/icon2.png" alt="icon image">
      </a>
      <div class="dropdown-options">
        <a
            data-th-href="@{${#session.getAttribute('loginUser') != null ? '/member/dashboard?no=' + #session.getAttribute('loginUser').memberNo : '/auth/login'}}"
            href="">대시보드</a>
        <th-block data-th-if="${#session.getAttribute('loginUser') != null}">
          <a data-th-href="@{'/member/mystudy?no=' + ${#session.getAttribute('loginUser').memberNo}}"
             href="">My
            스터디</a>
          <a data-th-href="@{'/member/mystudy?no=' + ${#session.getAttribute('loginUser').memberNo}}"
             href="">내가
            쓴 글/댓글 보기</a>
          <a data-th-href="@{'/member/edit'}" href="">회원 정보 수정</a>

        </th-block>
      </div>
    </div>
    <div>
      <span class="mr-sm-2" data-th-if="${session.loginUser != null}"
            data-th-text="${session.loginUser.email}">로그인 이메일</span>
      <span class="mr-sm-2"
            data-th-if="${session.loginUser != null}">  [[${session.platform}]]</span>
      <button data-th-if="${session.loginUser != null}" class="btn btn-outline-danger"
              onclick="location.href='/auth/logout';">로그아웃
      </button>
      <!-- 로그인 버튼 클릭 시 모달 열기 -->
      <button data-th-if="${session.loginUser == null}" class="btn-open-modal btn btn-outline-info"
              data-toggle="modal"
              data-target="#loginModal">로그인
      </button>
    </div>
  </div>
</nav>
<!--</header>-->

<body>


<!-- 로그인 모달 -->
<div class="modal" id="loginModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" id="loginModalContent">
    </div>
  </div>
</div>

<!-- 회원가입 모달 -->
<div data-th-if="${showModal}" class="modal" role="dialog" id="signUpModal" data-backdrop='static'
     data-keyboard='false'>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- 모달 창 내용 -->
      <!-- 모달 헤더 -->
      <div class="modal-header">
        <h5 class="modal-title">회원가입</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <!-- 모달 바디 -->
      <div class="modal-body">
        <!-- form start -->
        <div id="prevImgDiv">
          <img id="prevImg" class="btn-prev" src="/img/chevron-left-solid.svg"
               alt="back-button">
        </div>
        <form class="form-horizontal" id="signupFrm">
          <div id="step1" class="signup-step">
            <div class="form-group row">
              <label for="email" class="col-sm-2 col-form-label">Email</label>
              <div class="col-sm-10">
                <input type="email" class="form-control" id="email" name="email" placeholder="Email"
                       data-th-value="${loginEmail}" readonly>
              </div>
            </div>
            <div class="form-group row">
              <label for="platform" class="col-sm-2 col-form-label">로그인 플랫폼</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="platform" name="platform"
                       placeholder="platform"
                       data-th-value="${session.platform}" readonly>
              </div>
            </div>
            <div class="form-group row">
              <label for="userName" class="col-sm-2 col-form-label">닉네임</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="userName" name="userName"
                       placeholder="닉네임"
                       required>
              </div>
            </div>
          </div>
          <div id="step2" class="signup-step" style="display:none;">
            <div class="form-group row">
              <label for="belong" class="col-sm-2 col-form-label">소속</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" name="belong" id="belong" placeholder="소속">
              </div>
            </div>
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">직군</label>
              <div class="col-sm-10">
                <select id="jobGroup" name="jobGroup" class="form-control"
                        data-placeholder="직군을 선택해주세요">
                  <option>프론트엔드</option>
                  <option>백엔드</option>
                  <option>디자이너</option>
                  <option>IOS</option>
                  <option>안드로이드</option>
                  <option>DevOps</option>
                  <option>PM</option>
                  <option>기획</option>
                </select>
              </div>
            </div>
            <div class="form-group row">
              <label class="col-sm-2 col-form-label">경력</label>
              <div class="col-sm-10">
                <select id="career" name="career" class="form-control"
                        data-placeholder="경력을 선택해주세요">
                  <option value='1'>1 년차</option>
                  <option value='2'>2년차</option>
                  <option value='3'>3년차</option>
                  <option value='4'>4년차</option>
                  <option value='5'>5년 차</option>
                  <option value='6'>6년 차</option>
                  <option value='7'>7년 차</option>
                  <option value='8'>8년 차</option>
                  <option value='9'>9년 차</option>
                  <option value='10'>10년 차 이상</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-next btn btn-outline-info">다음</button>
        <button type="submit" class="btn btn-submit btn-outline-primary" style="display: none">가입!
        </button>
      </div>
    </div>
  </div>
</div>

<form id="isLoginFrm">
  <input type="hidden" id="showModal" data-th-value="${showModal}">
  <input type="hidden" id="loginEmail" data-th-value="${loginEmail}">
</form>

<!-- Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- Viewer -->
<!--
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.js"></script>
-->
<!-- Editor's Plugin -->
<script
    src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
<!-- axios -->
<script src="/plugins/axios/axios.min.js"></script>
<!-- 별도의 JavaScript 파일 추가 -->
<script type="module" src="/js/auth/modal.js"></script>

<script th:inline="javascript">
  // 팝업 창 요소를 가져옴
  var popup = document.getElementById("popupNotifications");

  // 닫기 버튼 요소를 가져옴
  var span = document.getElementsByClassName("close")[0];

  // 전역 변수로 현재 페이지와 총 페이지 수를 관리
  let currentPage = 0;
  let totalPages = 0;

  function showPopup() {
      document.getElementById('popupNotifications').style.display = 'block';
      fetchNotifications(); // 팝업이 열릴 때 초기 알림 내용 로딩
  }
  function closePopup() {
      document.getElementById('popupNotifications').style.display = 'none';
  }

  window.addEventListener('click', (e) => {
    if (!popup.contains(e.target)) { // 팝업의 자식 요소가 클릭 대상이 아닐 때
        popup.style.display = 'none';
    }
  });



function fetchNotifications() {
  // 초기 페이지 번호 설정
  currentPage = 0;
  totalPages = 0;
  popup.scrollTop = 0;

  // 목록이 표시되는 컨테이너의 내용을 초기화
  var notificationsContainer = document.getElementById('notifications');
  notificationsContainer.innerHTML = '';

  // 새로운 데이터를 불러오기 위해 fetchNotificationsWithPage 함수를 호출
  fetchNotificationsWithPage(currentPage);
}


function fetchNotificationsWithPage(page, append = false) {
    console.log("fetchNotifications 함수가 호출되었습니다. 페이지 번호:", page);
    fetch(`/noti/list?page=${page}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(notiListJson => {
            console.log(notiListJson);
            totalPages = notiListJson.totalPages; // 총 페이지 수 업데이트
            currentPage++; // 현재 페이지 업데이트
            displayNotifications(notiListJson, append); // append 인자를 전달
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
}


  span.onclick = function () {
      popup.style.display = "none";
  }
  window.onclick = function (event) {
      if (event.target == popup) {
          popup.style.display = "none";
      }
  }

  // 알림 목록과 함께 페이징 정보를 화면에 표시하는 함수
  function displayNotifications(notiListJson, append = false) {
    console.log("displayNotifications 함수가 호출되었습니다.");
    var notiList = notiListJson.content; // JSON.parse를 호출한 결과에서 content에 접근
    var totalPages = notiListJson.totalPages; // 총 페이지 수

    var notificationsContainer = document.getElementById('notifications');
    if (!append) {
        notificationsContainer.innerHTML = ''; // 기존에 표시된 알림을 클리어
    }
    popup.style.display = "block";

    if (notiList.length === 0) {
        if (!append) {
            notificationsContainer.textContent = '알림이 없습니다.';
        }
    } else {
        notiList.forEach(function (noti) {
            var notiElement = document.createElement('div');
            var linkElement = document.createElement('a');
            linkElement.href = noti.link; // 링크 설정
            linkElement.textContent = noti.message; // 메시지 텍스트 설정
            linkElement.addEventListener('click', function () {
                sendReadRequest(noti);
            });
            notiElement.appendChild(linkElement);
            notificationsContainer.appendChild(notiElement);
        });
    }
}


  function sendReadRequest(noti) {
      console.log("클릭 이벤트 발생");
      const requestBody = JSON.stringify({id: noti.id});

      console.log(requestBody);
     fetch('/noti/update', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: requestBody,
      })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Network response was not ok');
              }
              return response.json();
          })
          .then(data => {
              console.log(data);
              // 서버로부터의 응답 처리
          })
          .catch(error => {
              console.error('There has been a problem with your fetch operation:', error);
          });
  }

      var popupContent = document.querySelector(".popup-noti");

      popupContent.onscroll = function() {
      // 팝업 내부에서 끝에 도달했는지 확인
          if (popupContent.offsetHeight + popupContent.scrollTop >= popupContent.scrollHeight) {
              // 현재 페이지가 총 페이지 수보다 작은 경우에만 데이터 추가 로드
              if (currentPage < totalPages) {
                  fetchNotificationsWithPage(currentPage, true); // 여기에 true를 추가합니다.
              }
          }
      };


      // 알림 버튼 클릭 이벤트 핸들러 등록
      notiButton.addEventListener('click', function() {
          fetchNotifications(); // fetchNotifications 함수 호출
      });
</script>
