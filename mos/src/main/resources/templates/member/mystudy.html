<div data-th-replace="header :: header" xmlns:th="http://www.w3.org/1999/xhtml">머리말</div>

<div class="wrapper-mos">
    <div id="sidenav" class="sidenav">
        <a data-th-href="@{${#session.getAttribute('loginUser') != null ? '/member/dashboard?no=' + #session.getAttribute('loginUser').memberNo : '/auth/login'}}"
           href="">대시보드</a>
        <div data-th-if="${session.loginUser != null}">
            <a data-th-href="@{'/member/mystudy?no=' + ${session.loginUser.memberNo}}" href="">My 스터디</a>
            <a data-th-href="@{/member/edit}" href="">회원 정보 수정</a>
            <a data-th-href="@{/member/myWriteCommentList}" href="">내가 쓴 글/댓글 보기</a>
        </div>
    </div>

    <div class="container-mystudy"> <!-- 부트스트랩 컨테이너 추가 -->
        <table class="table"> <!-- 부트스트랩 테이블 클래스 추가 -->
            <thead>
            <tr>
                <th>Title</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th></th>
                <!-- 다른 필요한 열들도 추가할 수 있습니다 -->
            </tr>
            </thead>
            <tbody>
            <tr data-th-each="memberStudy : ${memberStudyList}">
                <!-- 스터디 제목 -->
                <td data-th-text="${memberStudy.studyDto != null ? memberStudy.studyDto.title : ''}"></td>
                <td data-th-text="${memberStudy.studyDto != null ? #dates.format(memberStudy.studyDto.startDate, 'yyyy-MM-dd') : ''}"></td>
                <td data-th-text="${memberStudy.studyDto != null ? #dates.format(memberStudy.studyDto.endDate, 'yyyy-MM-dd') : ''}"></td>
                <td>
                    <form id="studyWithdraw" data-th-if="${memberStudy.status == 'S03-102'}" data-th-action="@{/member/updateStatus}" method="post">
                        <input type="hidden" name="no" data-th-value="${memberStudy.no}">
                        <input type="hidden" name="status" data-th-value="${memberStudy.status}">
                        <button type="submit" class="btn btn-warning" data-th-text="스터디원"></button>
                    </form>
                    <form id="studyStatus" data-th-if="${memberStudy.status == 'S03-101'}" data-th-action="@{/member/studyManagement}" method="get">
                        <input type="hidden" name="studyNo" data-th-value="${memberStudy.studyDto.studyNo}">
                        <input type="hidden" name="status" data-th-value="${memberStudy.status}">
                        <button type="submit" class="btn btn-success" data-th-text="스터디장"></button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div> <!-- 부트스트랩 컨테이너 닫기 -->

    <!-- 결과를 표시할 모달 -->
    <!-- Bootstrap 모달 -->
    <div class="modal fade" id="jsonResultModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">스터디 신청 목록</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- JSON 결과를 버튼으로 표시할 곳 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // 폼 제출 이벤트를 가로채기
            $('#studyWithdraw').submit(function(e) {
                e.preventDefault(); // 폼 기본 제출 방지

                // '탈퇴하시겠습니까?' 확인 대화상자 표시
                var confirmResult = confirm('탈퇴하시겠습니까?');

                var formDataJson = {
                    id: $('input[name="no"]').val(),
                    message: $('input[name="status"]').val()
                };

                if (confirmResult) {
                    // 사용자가 '확인'을 클릭하면, AJAX를 통해 폼 데이터를 서버로 전송
                    var actionUrl = $(this).attr('action'); // 폼 액션 URL
                    $.ajax({
                        url: actionUrl, // 서버 엔드포인트 URL
                        type: 'POST', // HTTP 요청 메소드
                        contentType: 'application/json',
                        data: JSON.stringify(formDataJson), // 폼 데이터 직렬화
                        success: function(response) {
                            // 요청 성공 시 처리 로직
                            alert('탈퇴 처리가 완료되었습니다.');
                        },
                        error: function(xhr, status, error) {
                            // 요청 실패 시 처리 로직
                            alert('오류가 발생했습니다. 다시 시도해주세요.');
                        }
                    });
                }
            });
        });

                $(document).ready(function() {
                  $('#studyStatus').submit(function(e) {
                    e.preventDefault(); // 폼 기본 제출 방지
                    var actionUrl = $(this).attr('action'); // 폼 액션 URL

                    // AJAX 요청
                    $.ajax({
                      url: actionUrl,
                      type: 'get',
                      data: $(this).serialize(), // 폼 데이터 직렬화
                      success: function(response) {
                        $('.modal-body').empty(); // 모달 내용 초기화
                        // JSON 결과를 바탕으로 버튼 생성
                        $.each(response, function(index, item) {
                          // photo가 null이 아니면 해당 사진을, null이면 기본 사진을 표시
                          var defaultPhotoUrl = '/img/user2-160x160.jpg'; // 실제 경로에 맞게 수정하세요.
                          var photoUrl = item.photo ? item.photo : defaultPhotoUrl;
                          var photo = $('<img>').attr('src', photoUrl).css({'width': '100px', 'height': '100px'}); // 이미지 크기 조절

                        var container = $('<div>').css({
                          'text-align': 'left', // 텍스트를 왼쪽으로 정렬
                          'display': 'flex', // Flexbox 레이아웃 사용
                          'flex-direction': 'column' // 자식 요소를 세로로 나열 (위 아래로)
                        });

                        var memberName = $('<div>').text(item.memberName).css({'font-weight': 'bold'}); // 이름에 굵은 글씨 적용
                        var message = item.message ? $('<div>').text(item.message) : $('<div>').text("한 줄 소개가 없습니다."); // 한 줄 소개가 없는 경우 대체 텍스트 사용

                        var messageContainer = container.append(memberName).append(message);

                          var contentWrapper = $('<div>').css({'display': 'flex', 'align-items': 'center'}); // 가로로 나열하기 위한 래퍼
                          contentWrapper.append(photo).append(messageContainer); // 래퍼에 요소 추가

                        // 버튼 클릭 시 공통으로 사용할 함수 정의
                        function updateMemberStatus(message) {
                          $.ajax({
                            url: '/member/updateStatus', // 실제 서버 엔드포인트로 변경
                            type: 'post',
                            contentType: 'application/json',
                            data: JSON.stringify({id: item.id, message: message}), // 올바른 형태로 데이터 전송
                            success: function(response) {
                              console.log('Success:', response);
                              location.reload(true);
                            },
                            error: function(xhr, status, error) {
                              console.error('Error:', error);
                            }
                          });
                        }

                        // '승인' 버튼 생성 및 이벤트 핸들러 설정
                        var acceptBtn = $('<button>')
                          .addClass('btn btn-primary m-2')
                          .text('승인')
                          .click(function() {
                            updateMemberStatus('S03-102');
                          });

                        // '거절' 버튼 생성 및 이벤트 핸들러 설정
                        var refuseBtn = $('<button>')
                          .addClass('btn btn-primary m-2')
                          .text('거절')
                          .click(function() {
                            updateMemberStatus('S03-105');
                          });

                            contentWrapper.append(acceptBtn).append(refuseBtn);
                          $('.modal-body').append(contentWrapper); // 생성된 요소들을 모달에 추가
                        });
                        $('#jsonResultModal').modal('show'); // 모달 표시
                      }
                    });
                  });
                });
    </script>





    <!--<div data-th-replace="member/mystudy-view :: modal(${memberStudyList})"></div>-->

    <!-- 부트스트랩 자바스크립트 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous">
    </script>


</div>
<div data-th-replace="footer :: footer">꼬리말</div>
