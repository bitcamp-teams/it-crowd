<div data-th-replace="header :: header">머리말</div>

<div class="wrapper-mos">
    <div id="sidenav" class="sidenav">
        <a data-th-href="@{${#session.getAttribute('loginUser') != null ? '/member/dashboard?no=' + #session.getAttribute('loginUser').memberNo : '/auth/login'}}"
           href="">대시보드</a>
        <div data-th-if="${session.loginUser != null}">
            <a data-th-href="@{'/member/mystudy?no=' + ${session.loginUser.memberNo}}" href="">My 스터디</a>
            <a data-th-href="@{/member/edit}" href="">회원 정보 수정</a>
            <a data-th-href="@{/member/myWriteCommentList}" href="">내가 쓴 글/댓글 보기</a>
        </div>
    </div>

    <div class="container-mystudy"> <!-- 부트스트랩 컨테이너 추가 -->
        <table class="table"> <!-- 부트스트랩 테이블 클래스 추가 -->
            <thead>
            <tr>
                <th>Title</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th></th>
                <!-- 다른 필요한 열들도 추가할 수 있습니다 -->
            </tr>
            </thead>
            <tbody>
            <tr data-th-each="memberStudy : ${memberStudyList}">
                <!-- 스터디 제목 -->
                <td data-th-text="${memberStudy.studyDto != null ? memberStudy.studyDto.title : ''}"></td>
                <td data-th-text="${memberStudy.studyDto != null ? #dates.format(memberStudy.studyDto.startDate, 'yyyy-MM-dd') : ''}"></td>
                <td data-th-text="${memberStudy.studyDto != null ? #dates.format(memberStudy.studyDto.endDate, 'yyyy-MM-dd') : ''}"></td>
                <td>
                     <form id="studyStatus" data-th-action="@{/member/studyManagement}" method="get">
                          <input type="hidden" name="studyNo" data-th-value="${memberStudy.studyDto.studyNo}">
                          <input type="hidden" name="status" data-th-value="${memberStudy.status}">
                          <button type="submit" data-th-text="${memberStudy.status}" class="btn btn-primary"></button>
                     </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div> <!-- 부트스트랩 컨테이너 닫기 -->

    <!-- 결과를 표시할 모달 -->
    <!-- Bootstrap 모달 -->
    <div class="modal fade" id="jsonResultModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">JSON 결과</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- JSON 결과를 버튼으로 표시할 곳 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
          $('#studyStatus').submit(function(e) {
            e.preventDefault(); // 폼 기본 제출 방지
            var actionUrl = $(this).attr('action'); // 폼 액션 URL

            // AJAX 요청
            $.ajax({
              url: actionUrl,
              type: 'get',
              data: $(this).serialize(), // 폼 데이터 직렬화
              success: function(response) {
                $('.modal-body').empty(); // 모달 내용 초기화
                // JSON 결과를 바탕으로 버튼 생성
                $.each(response, function(index, item) {
                  // photo가 null이 아니면 해당 사진을, null이면 기본 사진을 표시
                  var defaultPhotoUrl = '/img/user2-160x160.jpg'; // 실제 경로에 맞게 수정하세요.
                  var photoUrl = item.photo ? item.photo : defaultPhotoUrl;
                  var photo = $('<img>').attr('src', photoUrl).css({'width': '100px', 'height': '100px'}); // 이미지 크기 조절

                  var memberName = $('<div>').text(item.memberName).css({'font-weight': 'bold'}); // 이름에 굵은 글씨 적용
                  var message = item.message ? $('<div>').text(item.message) : "한 줄 소개가 없습니다.";

                  var contentWrapper = $('<div>').css({'display': 'flex', 'align-items': 'center'}); // 가로로 나열하기 위한 래퍼
                  contentWrapper.append(photo).append(memberName).append(message); // 래퍼에 요소 추가

                  var btn = $('<button>')
                    .addClass('btn btn-primary m-2')
                    .text(item.status) // 가정: JSON 객체에 'status' 키가 있다고 가정
                    .click(function() {
                      // 버튼 클릭 시, 해당 JSON 데이터를 다시 서버로 요청
                      $.ajax({
                        url: '/member/updateStatus', // 실제 서버 엔드포인트로 변경
                        type: 'post',
                        contentType: 'application/json',
                        data: JSON.stringify(item.id, ), // JSON 객체를 문자열로 변환
                        success: function(response) {
                          // 처리 결과에 따른 추가 동작
                          console.log('Success:', response);
                        },
                        error: function(xhr, status, error) {
                          console.error('Error:', error);
                        }
                      });
                    });
                    contentWrapper.append(btn);
                  $('.modal-body').append(contentWrapper); // 생성된 요소들을 모달에 추가
                });
                $('#jsonResultModal').modal('show'); // 모달 표시
              }
            });
          });
        });
    </script>





    <!--<div data-th-replace="member/mystudy-view :: modal(${memberStudyList})"></div>-->

    <!-- 부트스트랩 자바스크립트 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous">
    </script>


</div>
<div data-th-replace="footer :: footer">꼬리말</div>
